apiVersion: v1
kind: Pod
metadata:
  name: etc-pki-entitlement-test
  namespace: builds-test
spec:
  serviceAccount: builder
  containers:
    - name: etc-pki-entitlement-test-container
      image: registry.access.redhat.com/ubi9/ubi:latest
      command:
        - /bin/sh
        - -c
        - |
          set -eu
          ORG_ID="$(echo -n "$(</etc/pki/entitlement/ORG_ID)")"
          KEY_NAME="$(echo -n "$(</etc/pki/entitlement/KEY_NAME)")"
          [ -n "${KEY_NAME}" ] || { echo "KEY_NAME is empty in the mounted secret"; exit 1; }


          echo “running subscribe”
          subscription-manager register \
            --org="${ORG_ID}" \
            --activationkey="${KEY_NAME}"


          # Example workload requiring entitlements
          dnf module enable -y nodejs:20
          dnf install -y nodejs


          subscription-manager unregister
          dnf clean all


          echo "dnf install succeeded. Exiting with code 0."
          exit 0
      volumeMounts:
        - name: secret-volume
          mountPath: /etc/pki/entitlement/
          readOnly: true
  volumes:
    - name: secret-volume
      csi:
        readOnly: true
        driver: csi.sharedresource.openshift.io
        volumeAttributes:
          sharedSecret: entitlement-key
  restartPolicy: Never
